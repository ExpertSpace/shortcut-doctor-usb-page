<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Shortcut Doctor USB - Восстановление USB накопителей</title>
    <link rel="Shortcut  icon" type="image/png" href="resources/icon16.png"/>
    <style>
        :root {
          --primary-color: #2c3e50;
          --secondary-color: #3498db;
          --accent-color: #e74c3c;
          --success-color: #27ae60;
          --warning-color: #f39c12;
          --light-bg: #ecf0f1;
          --dark-text: #2c3e50;
          --light-text: #ffffff;
          --card-bg: rgba(255, 255, 255, 0.95);
          --shadow: 0 8px 32px rgba(44, 62, 80, 0.1);
        }

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(
            135deg,
            var(--primary-color) 0%,
            var(--secondary-color) 100%
          );
          color: var(--dark-text);
          line-height: 1.6;
          min-height: 100vh;
          padding: 20px;
        }

        .container {
          max-width: 1000px;
          margin: 0 auto;
          background: var(--card-bg);
          border-radius: 20px;
          overflow: hidden;
          box-shadow: var(--shadow);
        }

        .header {
          background: linear-gradient(
            135deg,
            var(--primary-color) 0%,
            var(--secondary-color) 100%
          );
          color: var(--light-text);
          padding: 40px;
          text-align: center;
        }

        .logo-container {
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 15px;
          margin-bottom: 20px;
        }

        .logo {
          width: 96px;
          height: 96px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          border-radius: 16px;
          overflow: hidden;
          transform-origin: center;
          will-change: transform;
          backface-visibility: hidden;
          -webkit-backface-visibility: hidden;
          -webkit-transform: translateZ(0);
          animation: pulse 2000ms infinite;
          background: transparent;
        }

        .logo img {
          display: block;
          width: 100%;
          height: 100%;
          object-fit: contain;
          border-radius: 12px;
          background: transparent;
        }

        @keyframes pulse {
          0%,
          100% {
            transform: scale(1);
          }
          50% {
            transform: scale(1.08);
          }
        }

        .logo-text {
          font-size: 2.5rem;
          font-weight: bold;
          background: linear-gradient(
            45deg,
            var(--secondary-color),
            var(--success-color)
          );
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
        }

        .app-title {
          font-size: 2.2rem;
          font-weight: 300;
          margin-top: 6px;
        }
        .app-subtitle {
          font-size: 1.05rem;
          opacity: 0.95;
          font-weight: 300;
          margin-top: 6px;
        }

        .content {
          padding: 40px;
        }

        .download-options {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 20px;
          margin: 30px 0;
        }

        .download-card {
          background: var(--light-bg);
          padding: 25px;
          border-radius: 15px;
          text-align: center;
          border-left: 5px solid var(--success-color);
          transition: transform 0.3s ease;
        }

        .download-card.exe {
          border-left-color: var(--secondary-color);
        }
        .download-card:hover {
          transform: translateY(-5px);
        }

        .download-btn {
          display: inline-flex;
          align-items: center;
          gap: 10px;
          background: var(--success-color);
          color: white;
          padding: 15px 25px;
          text-decoration: none;
          border-radius: 50px;
          font-size: 1.1rem;
          font-weight: 600;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
          margin: 15px 0;
        }

        .download-btn.exe {
          background: var(--secondary-color);
          box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .file-info {
          background: rgba(0, 0, 0, 0.05);
          padding: 12px;
          border-radius: 8px;
          margin: 10px 0;
          font-family: "Courier New", monospace;
          font-size: 0.85rem;
          word-break: break-all;
        }

        .hash-value {
          color: var(--primary-color);
          font-weight: bold;
          word-break: break-all;
        }
        .version {
          display: block;
          margin-top: 5px;
          font-size: 0.9rem;
          color: #7f8c8d;
        }

        .features {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin: 40px 0;
        }
        .feature-card {
          background: var(--light-bg);
          padding: 25px;
          border-radius: 12px;
          text-align: center;
          transition: transform 0.3s ease;
        }
        .feature-card:hover {
          transform: translateY(-5px);
        }
        .feature-icon {
          font-size: 2.5rem;
          margin-bottom: 15px;
          color: var(--secondary-color);
        }

        .instructions {
          background: var(--primary-color);
          color: var(--light-text);
          padding: 40px;
          border-radius: 15px;
          margin: 40px 0;
        }
        .steps {
          display: grid;
          gap: 20px;
          margin-top: 20px;
        }
        .step {
          display: flex;
          align-items: flex-start;
          gap: 15px;
          padding: 15px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 8px;
        }
        .step-number {
          background: var(--secondary-color);
          color: white;
          width: 30px;
          height: 30px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          flex-shrink: 0;
        }

        .requirements {
          background: var(--warning-color);
          color: white;
          padding: 25px;
          border-radius: 12px;
          margin: 30px 0;
        }

        .footer {
          background: var(--primary-color);
          color: var(--light-text);
          text-align: center;
          padding: 30px;
          margin-top: 40px;
        }

        .warning {
          background: var(--accent-color);
          color: white;
          padding: 15px;
          border-radius: 8px;
          margin: 20px 0;
          text-align: center;
        }

        .stats {
          display: flex;
          justify-content: center;
          gap: 30px;
          margin: 20px 0;
          font-size: 0.9rem;
          color: #7f8c8d;
        }
        .stat-item {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        @media (max-width: 768px) {
          .header {
            padding: 30px 20px;
          }
          .app-title {
            font-size: 2rem;
          }
          .content {
            padding: 20px;
          }
          .download-options {
            grid-template-columns: 1fr;
          }
          .stats {
            flex-direction: column;
            gap: 10px;
          }
        }

        .contacts {
          display: flex;
          gap: 12px;
          align-items: center;
          justify-content: center;
          margin-top: 12px;
        }
        .contact-link {
          display: inline-flex;
          gap: 8px;
          align-items: center;
          color: var(--light-text);
          text-decoration: none;
          font-weight: 500;
          opacity: 0.95;
        }
        .contact-link svg {
          width: 18px;
          height: 18px;
        }

        .download-card > h3 > img {
          margin-bottom: 10px;
        }

        /* Выравнивание лого Windows */
        .download-card.exe h3 img {
          vertical-align: middle !important;
          position: relative;
          top: 2px;
          margin-bottom: 10px !important;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="logo-container">
            <div class="logo">
                <img src="resources/icon512.svg" alt="Shortcut Doctor USB"/>
            </div>
            <div>
                <div class="logo-text">Shortcut Doctor USB</div>
                <div class="app-title">Не является антивирусом</div>
                <div class="app-subtitle">
                    Профессиональное восстановление USB-накопителей
                </div>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="download-options">
            <div class="download-card">
                <h3>
                    <img src="resources/java-logo.png"
                         alt="Java"
                         style="height: 1.2em; vertical-align: middle"
                    />
                    JAR версия (требует Java)
                </h3>
                <a
                        href="releases/ShortcutDoctorUSB-1.0.0.jar"
                        download
                        class="download-btn"
                        id="downloadJar"
                >⬇️ Скачать JAR</a
                >
                <span class="version"
                >Версия <span id="jarVersion">—</span> |
              <span id="jarSize">—</span></span
                >
                <div class="file-info">
                    <strong>SHA-256:</strong><br/><span
                        class="hash-value"
                        id="jarHash"
                >—</span
                >
                </div>
            </div>
            <div class="download-card exe">
                <h3>
                    <img
                            src="resources/win-logo.png"
                            alt="Win"
                            style="height: 1.0em; vertical-align: middle"
                    />
                    EXE версия (Windows)
                </h3>
                <a
                        href="releases/ShortcutDoctorUSB-1.0.0.exe"
                        download
                        class="download-btn exe"
                        id="downloadExe"
                >⬇️ Скачать EXE</a
                >
                <span class="version"
                >Версия <span id="exeVersion">—</span> |
              <span id="exeSize">—</span></span
                >
                <div class="file-info">
                    <strong>SHA-256:</strong><br/><span
                        class="hash-value"
                        id="exeHash"
                >—</span
                >
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                👁️ Просмотров: <span id="viewCount">0</span>
            </div>
            <div class="stat-item">
                📥 JAR: <span id="downloadJarCount">0</span>
            </div>
            <div class="stat-item">
                📥 EXE: <span id="downloadExeCount">0</span>
            </div>
        </div>

        <div class="warning">
            ⚠️ Перед использованием закройте все открытые файлы на USB-накопителе
        </div>

        <div class="features">
            <div class="feature-card">
                <div class="feature-icon">
                    <img src="resources/scan-icon.png"
                         alt="Scan"
                         style="height: 1.2em; vertical-align: middle"
                    />
                </div>
                <h3>Глубокое сканирование</h3>
                <p>Обнаружение всех скрытых и системных файлов</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">
                    <img src="resources/recovery-icon.png"
                         alt="Recovery"
                         style="height: 1.2em; vertical-align: middle"
                    />
                </div>
                <h3>Восстановление данных</h3>
                <p>Безопасное восстановление скрытых файлов</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">
                    <img src="resources/shield-icon.png"
                         alt="Shield"
                         style="height: 1.2em; vertical-align: middle"
                    />
                </div>
                <h3>Интеграция VirusTotal</h3>
                <p>Сканирование исполняемых файлов через VirusTotal</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">
                    <img src="resources/optimizm-icon.png"
                         alt="Optimist"
                         style="height: 1.2em; vertical-align: middle"
                    />
                </div>
                <h3>Быстрая работа</h3>
                <p>Оптимизированный алгоритм обработки</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">
                    <img src="resources/log-icon.png"
                         alt="Log"
                         style="height: 1.2em; vertical-align: middle"
                    />
                </div>
                <h3>Детальное логирование</h3>
                <p>Полные отчеты о проделанной работе</p>
            </div>
        </div>

        <div class="instructions">
            <h2>🎯 Инструкция пользования программой</h2>
            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <div>
                        Скачайте подходящую версию (JAR или EXE) (рекомендуется EXE)
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div>Подключите USB-накопитель к компьютеру</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div>Запустите программу</div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div>Выберите нужный USB-накопитель в списке</div>
                </div>
                <div class="step">
                    <div class="step-number">5</div>
                    <div>
                        Нажмите кнопку <strong>"Исправить ярлыки"</strong> или
                        <strong>"Сканировать"</strong>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">5</div>
                    <div>
                        Для сканирования понадобится <strong>API ключ</strong> от
                        VirusTotal, который можно получить после регистрации
                    </div>
                </div>
            </div>
        </div>

        <div class="requirements">
            <h3>📋 Системные требования</h3>
            <ul>
                <li>✅ <strong>JAR версия:</strong> Java 23</li>
                <li>✅ <strong>EXE версия:</strong> Windows 7/8/10/11 (x64)</li>
            </ul>
        </div>
    </div>

    <div class="footer">
        <p>© 2025 Shortcut Doctor USB</p>
        <div class="contacts">
            <a
                    class="contact-link"
                    href="https://t.me/Minmaxminor"
                    target="_blank"
            >
                <svg viewBox="0 0 240 240">
                    <path
                            fill="#fff"
                            d="M120 0C53.7 0 0 53.7 0 120s53.7 120 120 120 120-53.7 120-120S186.3 0 120 0zm52.9 80.1l-22 103.5c-1.7 7.5-6.1 9.5-12.4 6.1l-34.4-25.6-16.6 16c-1.8 1.8-3.3 3.3-6.6 3.3l2.4-34.2 62.2-56.2c2.7-2.4-0.6-3.8-4.1-1.4L69.2 127.6 28.5 115.6c-7-2.2-7.1-7-1.5-10.4L171.3 63.9c6.3-2.8 11.6 1.6 9.6 16.2z"
                    />
                </svg>
                <span>@Minmaxminor</span>
            </a>
            <span class="contact-link" style="cursor: default">
            <svg viewBox="0 0 24 24">
              <path
                      fill="#fff"
                      d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5L4 8V6l8 5 8-5v2z"
              />
            </svg>
            <span>minmaxminor@ya.ru</span>
          </span>
        </div>
    </div>
</div>

<script type="module">
    // Firebase импорты
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getAnalytics,
      logEvent,
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
    import {
      getFirestore,
      doc,
      setDoc,
      increment,
      onSnapshot,
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // Firebase конфигурация
    const firebaseConfig = {
      apiKey: "AIzaSyCOA7mkCs8VbEmvcf457iHI_5RyZp8Bb7U",
      authDomain: "my-web-counters-shortcutdoctor.firebaseapp.com",
      projectId: "my-web-counters-shortcutdoctor",
      storageBucket: "my-web-counters-shortcutdoctor.firebasestorage.app",
      messagingSenderId: "762641699109",
      appId: "1:762641699109:web:23c2affa6def3181888acc",
      measurementId: "G-77X98KEZ27",
    };

    // Инициализация Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // Функция для форматирования чисел
    function formatNumber(num) {
      if (!num && num !== 0) return "—";
      if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
      if (num >= 1000) return (num / 1000).toFixed(1) + "K";
      return num.toString();
    }

    // Основная функция обновления счетчиков Firebase
    async function updateFirebaseCounter(
      counterName,
      elementId,
      isIncrement = false
    ) {
      try {
        const counterRef = doc(db, "counters", "shortcut-doctor");

        if (isIncrement) {
          await setDoc(
            counterRef,
            {
              [counterName]: increment(1),
              lastUpdated: new Date(),
            },
            { merge: true }
          );

          logEvent(
            analytics,
            counterName === "views" ? "page_view" : "download",
            {
              file_type: counterName,
              page_title: document.title,
            }
          );
        }

        onSnapshot(counterRef, (docSnapshot) => {
          if (docSnapshot.exists()) {
            const data = docSnapshot.data();
            const value = data[counterName] || 0;
            const element = document.getElementById(elementId);
            if (element) {
              element.textContent = formatNumber(value);
            }
          }
        });
      } catch (error) {
        console.warn("Firebase error:", error);
        const element = document.getElementById(elementId);
        if (element) element.textContent = "—";
      }
    }

    // Функция для bytesToHuman
    function bytesToHuman(bytes) {
      if (!bytes) return "—";
      const sizes = ["B", "KB", "MB", "GB", "TB"];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return `${(bytes / Math.pow(1024, i)).toFixed(i === 0 ? 0 : 2)} ${
        sizes[i]
      }`;
    }

    // Универсальная функция для поиска данных файла по паттерну
    function findFileData(data, patterns) {
      for (const pattern of patterns) {
        if (data[pattern]) {
          return data[pattern];
        }
      }

      // Если не нашли по точным паттернам, ищем по частичному совпадению
      const keys = Object.keys(data);
      for (const key of keys) {
        for (const pattern of patterns) {
          if (key.toLowerCase().includes(pattern.toLowerCase())) {
            return data[key];
          }
        }
      }

      return null;
    }

    // Функция для загрузки hashes.json - УНИВЕРСАЛЬНАЯ ВЕРСИЯ
    async function loadHashes() {
      try {
        const resp = await fetch("hashes.json");
        if (!resp.ok) throw new Error("Не удалось загрузить hashes.json");
        const data = await resp.json();

        console.log("Loaded hashes data:", data); // Для отладки
        console.log("Available keys:", Object.keys(data)); // Для отладки

        // Паттерны для поиска JAR файла
        const jarPatterns = [
          "ShortcutDoctorUSB.jar",
          "shortcutdoctor.jar",
          ".jar",
        ];

        // Паттерны для поиска EXE файла
        const exePatterns = [
          "ShortcutDoctorUSB.exe",
          "ShortcutDoctorUSB-1.0.0.exe",
          "shortcutdoctor.exe",
          ".exe",
        ];

        // Поиск данных для JAR файла
        const jarData = findFileData(data, jarPatterns);
        if (jarData) {
          document.getElementById("jarSize").textContent = bytesToHuman(
            jarData.size
          );
          document.getElementById("jarHash").textContent =
            jarData.sha256 || "—";
          document.getElementById("jarVersion").textContent =
            jarData.version || "—";
          console.log("JAR data loaded:", jarData);
        } else {
          console.warn("JAR data not found in hashes.json");
          document.getElementById("jarSize").textContent = "—";
          document.getElementById("jarHash").textContent = "—";
          document.getElementById("jarVersion").textContent = "—";
        }

        // Поиск данных для EXE файла
        const exeData = findFileData(data, exePatterns);
        if (exeData) {
          document.getElementById("exeSize").textContent = bytesToHuman(
            exeData.size
          );
          document.getElementById("exeHash").textContent =
            exeData.sha256 || "—";
          document.getElementById("exeVersion").textContent =
            exeData.version || "—";
          console.log("EXE data loaded:", exeData);
        } else {
          console.warn("EXE data not found in hashes.json");
          document.getElementById("exeSize").textContent = "—";
          document.getElementById("exeHash").textContent = "—";
          document.getElementById("exeVersion").textContent = "—";
        }
      } catch (e) {
        console.error("Error loading hashes:", e);
        // Устанавливаем прочерки при ошибке
        document.getElementById("jarSize").textContent = "—";
        document.getElementById("jarHash").textContent = "—";
        document.getElementById("jarVersion").textContent = "—";
        document.getElementById("exeSize").textContent = "—";
        document.getElementById("exeHash").textContent = "—";
        document.getElementById("exeVersion").textContent = "—";
      }
    }

    // Умное отслеживание просмотров
    function setupSmartViewTracking() {
      let viewCounted = sessionStorage.getItem("viewCounted");

      if (!viewCounted) {
        let viewTracked = false;

        const trackView = async (reason) => {
          if (!viewTracked && document.visibilityState === "visible") {
            viewTracked = true;
            await updateFirebaseCounter("views", "viewCount", true);
            sessionStorage.setItem("viewCounted", "true");

            logEvent(analytics, "page_view", {
              page_title: document.title,
              page_location: window.location.href,
              trigger: reason,
            });
          }
        };

        // Триггер 1: Провел 5 секунд на странице
        setTimeout(() => {
          trackView("time_spent");
        }, 5000);

        // Триггер 2: Прокрутил до 50% страницы
        const handleScroll = () => {
          const scrollTop =
            window.scrollY || document.documentElement.scrollTop;
          const scrollHeight = document.documentElement.scrollHeight;
          const clientHeight = window.innerHeight;
          const scrollPercent =
            (scrollTop / (scrollHeight - clientHeight)) * 100;

          if (scrollPercent > 50) {
            trackView("scroll_depth");
            window.removeEventListener("scroll", handleScroll);
          }
        };

        window.addEventListener("scroll", handleScroll);
      }
    }

    // Автоматическое обновление ссылок скачивания на основе hashes.json
    async function updateDownloadLinks() {
      try {
        const resp = await fetch("hashes.json");
        if (!resp.ok) return;
        const data = await resp.json();

        const keys = Object.keys(data);

        // Находим актуальные имена файлов
        const jarKey = keys.find((key) => key.toLowerCase().includes(".jar"));
        const exeKey = keys.find((key) => key.toLowerCase().includes(".exe"));

        // Обновляем ссылки если нашли файлы
        const jarLink = document.getElementById("downloadJar");
        const exeLink = document.getElementById("downloadExe");

        if (jarKey && jarLink) {
          jarLink.href = jarKey;
          console.log("Updated JAR link to:", jarKey);
        }

        if (exeKey && exeLink) {
          exeLink.href = exeKey;
          console.log("Updated EXE link to:", exeKey);
        }
      } catch (error) {
        console.warn("Error updating download links:", error);
      }
    }

    // Инициализация счетчиков
    async function initializeCounters() {
      await loadHashes();
      await updateDownloadLinks(); // Обновляем ссылки скачивания

      // Загружаем текущие значения счетчиков
      await updateFirebaseCounter("views", "viewCount", false);
      await updateFirebaseCounter("jarDownloads", "downloadJarCount", false);
      await updateFirebaseCounter("exeDownloads", "downloadExeCount", false);

      // Настраиваем умное отслеживание просмотров
      setupSmartViewTracking();
    }

    // Универсальные обработчики скачивания
    function setupDownloadHandlers() {
      const jarLink = document.getElementById("downloadJar");
      const exeLink = document.getElementById("downloadExe");

      // Универсальный обработчик для JAR
      if (jarLink) {
        jarLink.addEventListener("click", async function (e) {
          // Получаем актуальное имя файла из href
          const fileName = this.href.split("/").pop();
          console.log("JAR download:", fileName);

          setTimeout(async () => {
            await updateFirebaseCounter(
              "jarDownloads",
              "downloadJarCount",
              true
            );
          }, 100);
        });
      }

      // Универсальный обработчик для EXE
      if (exeLink) {
        exeLink.addEventListener("click", async function (e) {
          // Получаем актуальное имя файла из href
          const fileName = this.href.split("/").pop();
          console.log("EXE download:", fileName);

          setTimeout(async () => {
            await updateFirebaseCounter(
              "exeDownloads",
              "downloadExeCount",
              true
            );
          }, 100);
        });
      }
    }

    // Запуск при загрузке DOM
    document.addEventListener("DOMContentLoaded", function () {
      initializeCounters();
      setupDownloadHandlers();
    });
</script>
</body>
</html>